name: Build Node.js ARM32

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-arm32:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: "r25b"
      ANDROID_API_LEVEL: "21"
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git python3 make clang curl unzip

      - name: Download Android NDK
        run: |
          curl -o android-ndk.zip https://dl.google.com/android/repository/android-ndk-$ANDROID_NDK_VERSION-linux.zip
          unzip android-ndk.zip -d $HOME
          export ANDROID_NDK=$HOME/android-ndk-$ANDROID_NDK_VERSION

      - name: Setup standalone toolchain
        run: |
          $ANDROID_NDK/build/tools/make_standalone_toolchain.py \
            --arch arm \
            --api $ANDROID_API_LEVEL \
            --install-dir=$HOME/android-toolchain
          export PATH=$HOME/android-toolchain/bin:$PATH
          export CC=armv7a-linux-androideabi-clang
          export CXX=armv7a-linux-androideabi-clang++
          export AR=arm-linux-androideabi-ar
          export LD=arm-linux-androideabi-ld
          export RANLIB=arm-linux-androideabi-ranlib

      - name: Configure Node.js
        run: |
          ./configure \
            --prefix=$HOME/node-android-arm \
            --cross-compiling \
            --dest-cpu=arm \
            --dest-os=android \
            --without-snapshot

      - name: Build Node.js
        run: make -j$(nproc)

      - name: Install Node.js
        run: make install

      - name: Verify
        run: |
          $HOME/node-android-arm/bin/node -v